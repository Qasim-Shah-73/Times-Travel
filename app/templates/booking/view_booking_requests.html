{% extends "index.html" %}
{% block title %}View Booking Requests{% endblock %}

{% block content %}
<div class="container mx-auto mt-8 px-4">
    <h1 class="text-3xl font-bold text-blue-800 mb-6">Booking Requests</h1>

    {% if requests %}
        <div class="overflow-x-auto bg-white rounded-lg shadow-lg border border-blue-200">
            <table class="min-w-full divide-y divide-blue-200">
                <thead class="bg-blue-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-xs font-semibold text-blue-700 uppercase tracking-wider">Agent Name</th>
                        <th scope="col" class="px-6 py-3 text-xs font-semibold text-blue-700 uppercase tracking-wider">Hotel Name</th>
                        <th scope="col" class="px-6 py-3 text-xs font-semibold text-blue-700 uppercase tracking-wider">Check-in Date</th>
                        <th scope="col" class="px-6 py-3 text-xs font-semibold text-blue-700 uppercase tracking-wider">Check-out Date</th>
                        <th scope="col" class="px-6 py-3 text-xs font-semibold text-blue-700 uppercase tracking-wider">Room Type</th>
                        <th scope="col" class="px-6 py-3 text-xs font-semibold text-blue-700 uppercase tracking-wider">Guest Name</th>
                        <th scope="col" class="px-6 py-3 text-xs font-semibold text-blue-700 uppercase tracking-wider">Status</th>
                        <th scope="col" class="px-6 py-3 text-xs font-semibold text-blue-700 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-blue-100">
                    {% for request in requests %}
                        <tr class="hover:bg-blue-50 transition-colors duration-200">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-blue-900">{{ request.agent.username }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-blue-900">{{ request.hotel_name }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600">{{ request.check_in.strftime('%d %b, %Y') }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600">{{ request.check_out.strftime('%d %b, %Y') }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600">{{ request.room_type }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600">{{ request.guest_name }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600">
                                {{ 'Accepted' if request.status else 'Rejected' }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button onclick="openAcceptDialog({{ request.id }})" class="text-green-600 hover:text-green-900 mr-3">Accept</button>
                                <button onclick="openRejectDialog({{ request.id }})" class="text-red-600 hover:text-red-900">Reject</button>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="bg-white shadow-md rounded-lg p-6 border border-blue-200">
            <p class="text-blue-600 text-center">No booking requests available at this time.</p>
        </div>
    {% endif %}
</div>

<!-- Accept Dialog -->
<div id="acceptDialog" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center">
    <div class="bg-white p-8 rounded-lg shadow-xl">
        <h2 class="text-xl font-bold mb-4">Accept Booking Request</h2>
        <form id="acceptForm">
            <input type="hidden" id="acceptRequestId" name="requestId">
            <div class="mb-4">
                <label for="price" class="block text-sm font-medium text-gray-700">Price</label>
                <input type="number" id="price" name="price" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
            </div>
            <div class="flex justify-end space-x-2">
                <button type="button" onclick="closeAcceptDialog()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Submit</button>
            </div>
        </form>
    </div>
</div>

<!-- Reject Dialog -->
<div id="rejectDialog" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center">
    <div class="bg-white p-8 rounded-lg shadow-xl">
        <h2 class="text-xl font-bold mb-4">Reject Booking Request</h2>
        <p class="mb-4">Are you sure you want to reject this booking request?</p>
        <div class="flex justify-end space-x-2">
            <button onclick="closeRejectDialog()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
            <button onclick="rejectRequest()" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Confirm Reject</button>
        </div>
    </div>
</div>

<script>
    let currentRequestId = null;

    function openAcceptDialog(requestId) {
        currentRequestId = requestId;
        document.getElementById('acceptRequestId').value = requestId;
        document.getElementById('acceptDialog').classList.remove('hidden');
        document.getElementById('acceptDialog').classList.add('flex');
    }

    function closeAcceptDialog() {
        document.getElementById('acceptDialog').classList.remove('flex');
        document.getElementById('acceptDialog').classList.add('hidden');
        document.getElementById('acceptForm').reset();
    }

    function openRejectDialog(requestId) {
        currentRequestId = requestId;
        document.getElementById('rejectDialog').classList.remove('hidden');
        document.getElementById('rejectDialog').classList.add('flex');
    }

    function closeRejectDialog() {
        document.getElementById('rejectDialog').classList.remove('flex');
        document.getElementById('rejectDialog').classList.add('hidden');
    }

    document.getElementById('acceptForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const price = document.getElementById('price').value;
        updateReservation(currentRequestId, 'approved', price);
        closeAcceptDialog();
    });

    function rejectRequest() {
        updateReservation(currentRequestId, 'rejected');
        closeRejectDialog();
    }

    function updateReservation(requestId, status, price = null) {
        const data = {
            status: status,
            price: price
        };

        fetch(`/update_reservation/${requestId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            console.log('Success:', data);
            location.reload();  // For simplicity, we're just reloading the page
        })
        .catch((error) => {
            console.error('Error:', error);
        });
    }
</script>

{% endblock %}